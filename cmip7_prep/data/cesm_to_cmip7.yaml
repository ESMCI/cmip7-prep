
# cesm_to_cmip7.yaml â€” CMIP-keyed schema with CMIP6 compatibility
#
# Top-level keys are CMIP variable names.
# Each variable can be defined either with:
#   - new-style 'sources' (preferred for complex/multi-source),
#   - or CMIP6-style 'raw_variables' + 'formula' (+ 'unit_conversion', 'levels', etc.).
#
# This allows direct reuse of CMIP6 tables while supporting newer expressive mappings.

dataset_overrides:
  grid_label: gr1
  institution_id: NCAR
  source_id: CESM3
  nominal_resolution: 100 km

variables:

  tas:
    table: Amon
    units: K
    long_name: Near-Surface Air Temperature
    standard_name: air_temperature
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: TS

  psl:
    table: Amon
    units: Pa
    long_name: Sea Level Pressure
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: PSL

  ps:
    table: Amon
    units: Pa
    long_name: Surface Air Pressure
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: PS

  pr:
    table: Amon
    units: kg m-2 s-1
    long_name: Precipitation
    standard_name: precipitation_flux
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: conservative
    sources:
      - cesm_var: PRECT
        scale: 1000.0   # convert from m/s to kg m-2 s-1 if needed

  evspsbl:
    table: Amon
    units: kg m-2 s-1
    long_name: Evaporation
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: conservative
    sources:
      - cesm_var: QFLX
        scale: -1.0     # flip sign if CESM positive upward

  huss:
    table: Amon
    units: "1"
    long_name: Near-Surface Specific Humidity
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: QREFHT
        as: qref
      - cesm_var: TREFHT
        as: tref
        optional: true
      - cesm_var: PS
        as: ps
        optional: true
      - cesm_var: RHREFHT
        as: rh
        optional: true
      - expr: "qref if qref is not None else rh_to_q(rh, tref, ps)"

  ta:
    table: Amon
    units: K
    long_name: Air Temperature
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    levels:
      name: plev19
      units: Pa
    requires_plev19: true
    sources:
      - cesm_var: T

  ua:
    table: Amon
    units: m s-1
    long_name: Zonal Wind
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    requires_plev19: true
    sources:
      - cesm_var: U

  va:
    table: Amon
    units: m s-1
    long_name: Meridional Wind
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    requires_plev19: true
    sources:
      - cesm_var: V

  mrso:
    table: Lmon
    units: kg m-2
    long_name: Total Soil Moisture Content
    dims: [time, lat, lon]
    regrid_method: conservative
    sources:
      - cesm_var: QSOIL
        as: qsoil
      - cesm_var: LANDMASK
        as: landmask
        optional: true
      - expr: "qsoil.where(landmask > 0.5) if landmask is not None else qsoil"

  mmrbc:
    table: AERmon
    units: kg kg-1
    long_name: Black carbon mass mixing ratio
    dims: [time, lev, lat, lon]
    regrid_method: bilinear
    positive: null

    # CMIP6-style fields
    raw_variables: [bc_a1, bc_a4, bc_c1, bc_c4]
    formula: bc_a1 + bc_a4 + bc_c1 + bc_c4
    unit_conversion: null
    levels:
      name: standard_hybrid_sigma
      units: "1"
      src_axis_name: lev
      src_axis_bnds: ilev

fx:
  areacella:
    units: m2
    source: cell_area
  sftlf:
    units: '%'
    source: sftlf
