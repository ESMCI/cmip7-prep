
# cesm_to_cmip7.yaml — CMIP-keyed schema with CMIP6 compatibility
#
# Top-level keys are CMIP variable names.
# Each variable can be defined either with:
#   - new-style 'sources' (preferred for complex/multi-source),
#   - or CMIP6-style 'raw_variables' + 'formula' (+ 'unit_conversion', 'levels', etc.).
#
# This allows direct reuse of CMIP6 tables while supporting newer expressive mappings.

dataset_overrides:
  grid_label: gr1
  institution_id: NCAR
  source_id: CESM3
  nominal_resolution: 100 km

variables:
  cl:
    table: Amon
    units: "%"
    long_name: Cloud Area Fraction
    standard_name: cloud_area_fraction
    cell_methods: "time: mean"
    dims: [time, lev, lat, lon]         # keep model levels
    formula: CLOUD * 100
    levels:
      name: standard_hybrid_sigma
      units: "1"
      src_axis_name: lev                 # model midlevel dimension
      src_axis_bnds: ilev                # model interface/bounds dim (if you ever need it)
      hyam: hyam                         # 1D (lev,)
      hybm: hybm                         # 1D (lev,)
      ps: PS                             # (time, lat, lon) — regridded with the rest
      p0: P0                             # scalar (Pa); default to 100000 if missing
    sources:
      - cesm_var: CLOUD
  cli:
    table: Amon
    units: "kg kg-1"
    dims: [time, lev, lat, lon]
    levels:
      name: standard_hybrid_sigma
      units: "1"
      src_axis_name: lev
      src_axis_bnds: ilev
    sources:
      - cesm_var: CLDICE

  clivi:
    table: Amon
    units: "kg m-2"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TGCLDIWP

  clt:
    table: Amon
    units: "%"
    dims: [time, lat, lon]
    formula: CLDTOT * 100
    sources:
      - cesm_var: CLDTOT

  clw:
    table: Amon
    units: "kg kg-1"
    dims: [time, lev, lat, lon]
    levels:
      name: standard_hybrid_sigma
      units: "1"
      src_axis_name: lev
      src_axis_bnds: ilev
    sources:
      - cesm_var: CLDLIQ

  clwvi:
    table: Amon
    units: "kg m-2"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TGCLDLWP

  evspsbl:
    table: Amon
    units: kg m-2 s-1
    long_name: Evaporation
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: conservative
    sources:
      - cesm_var: QFLX
        scale: -1.0     # flip sign if CESM positive upward

  hfls:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: LHFLX

  hfss:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: SHFLX

  hur:
    table: Amon
    units: "%"
    dims: [time, plev, lat, lon]
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: RELHUM

  hurs:
    table: Amon
    units: "%"
    dims: [time, lat, lon]
    sources:
      - cesm_var: RHREFHT

  hus:
    table: Amon
    units: "kg kg-1"
    dims: [time, plev, lat, lon]
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: Q

  huss:
    table: Amon
    units: "1"
    long_name: Near-Surface Specific Humidity
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: QREFHT

  pr:
    table: Amon
    units: kg m-2 s-1
    long_name: Precipitation
    standard_name: precipitation_flux
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: conservative
    sources:
      - cesm_var: PRECT
        scale: 1000.0   # convert from m/s to kg m-2 s-1 if needed
  prc:
    table: Amon
    units: "kg m-2 s-1"
    dims: [time, lat, lon]
    # PRECC is in m s-1 (water equivalent) → convert to kg m-2 s-1
    formula: PRECC * 1000.0
    sources:
      - cesm_var: PRECC

  prsn:
    table: Amon
    units: "kg m-2 s-1"
    dims: [time, lat, lon]
    # PRECSC/PRECSL are snowfall rates in m s-1 (water equiv) → convert to kg m-2 s-1
    formula: (PRECSC + PRECSL) * 1000.0
    sources:
      - cesm_var: PRECSC
      - cesm_var: PRECSL

  prw:
    table: Amon
    units: "kg m-2"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TMQ

  psl:
    table: Amon
    units: Pa
    long_name: Sea Level Pressure
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: PSL
  ps:
    table: Amon
    units: Pa
    long_name: Surface Air Pressure
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: PS
  rlds:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FLDS

  rldscs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    formula: FLDS + FLNS - FLNSC
    sources:
      - cesm_var: FLDS
      - cesm_var: FLNS
      - cesm_var: FLNSC

  rlus:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    formula: FLDS + FLNS
    sources:
      - cesm_var: FLDS
      - cesm_var: FLNS
  rluscs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FLUSC

  rlut:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FLUT

  rlutcs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FLUTC

  rsds:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FSDS

  rsdscs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FSDSC

  rsdt:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: SOLIN

  rsus:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FSUS

  rsuscs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FSUSC

  rsut:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: FSUTOA

  rsutcs:
    table: Amon
    units: "W m-2"
    dims: [time, lat, lon]
    sources:
      - cesm_var: FSUTOAC

  sfcWind:
    table: Amon
    units: "m s-1"
    dims: [time, lat, lon]
    sources:
      - cesm_var: U10

  ta:
    table: Amon
    units: K
    long_name: Air Temperature
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: T

  tas:
    table: Amon
    units: K
    long_name: Near-Surface Air Temperature
    standard_name: air_temperature
    cell_methods: "time: mean"
    dims: [time, lat, lon]
    regrid_method: bilinear
    sources:
      - cesm_var: TS

  tasmax:
    table: Amon
    units: "K"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TREFHTMX

  tasmin:
    table: Amon
    units: "K"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TREFHTMN

  tauu:
    table: Amon
    units: "N m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: TAUX

  tauv:
    table: Amon
    units: "N m-2"
    dims: [time, lat, lon]
    positive: up
    sources:
      - cesm_var: TAUY

  ts:
    table: Amon
    units: "K"
    dims: [time, lat, lon]
    sources:
      - cesm_var: TS

  ua:
    table: Amon
    units: m s-1
    long_name: Zonal Wind
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: U

  uas:
    table: Amon
    units: "m s-1"
    dims: [time, lat, lon]
    sources:
      - cesm_var: U10

  va:
    table: Amon
    units: m s-1
    long_name: Meridional Wind
    dims: [time, plev, lat, lon]
    regrid_method: bilinear
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: V
  vas:
    table: Amon
    units: "m s-1"
    dims: [time, lat, lon]
    sources:
      - cesm_var: V10

  wap:
    table: Amon
    units: "Pa s-1"
    dims: [time, plev, lat, lon]
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: OMEGA

  zg:
    table: Amon
    units: "m"
    dims: [time, plev, lat, lon]
    levels:
      name: plev19
      units: Pa
    sources:
      - cesm_var: Z3

fx:
  areacella:
    units: m2
    source: cell_area
  sftlf:
    units: '%'
    source: sftlf
